"""
–ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è Telegram-–±–æ—Ç–∞.

–°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ Reply- –∏ Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏ –±–æ—Ç–∞,
–∞ —Ç–∞–∫–∂–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤ –ü–í–ó –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è
–ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
- –í—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –∏–ª–∏ –∑–∞–∫–∞–∑–∞.
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ –∏ —Å–ø–∏—Å–∫–∞ –ø—É–Ω–∫—Ç–æ–≤ –≤—ã–¥–∞—á–∏ (–ü–í–ó).
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –ü–í–ó —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞.

–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  ‚Ä¢ –û–±—â–∏–µ (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, —Å—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω),
  ‚Ä¢ –û—Ç–∑—ã–≤—ã,
  ‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–≤—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–∞ ‚Üí –≤—ã–±–æ—Ä –ü–í–ó ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ).

–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã:
  ‚Ä¢ `clean_address_label` ‚Äî —É–¥–∞–ª—è–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å—ã –≤—Ä–æ–¥–µ '–ê–¥—Ä–µ—Å:', '–ü–í–ó:'.
  ‚Ä¢ `extract_street_address` ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç —É–ª–∏—á–Ω—É—é —á–∞—Å—Ç—å –∞–¥—Ä–µ—Å–∞, –∏—Å–∫–ª—é—á–∞—è –≥–æ—Ä–æ–¥.

"""

from aiogram.types import (
    ReplyKeyboardMarkup,
    KeyboardButton,
    InlineKeyboardMarkup,
    InlineKeyboardButton
)
from config import WB
import re

b1 = KeyboardButton(text='‚ÑπÔ∏è –ß—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç')
b2 = KeyboardButton(text='üçµ –ê—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç')
b3 = KeyboardButton(text='üõí –°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω')
b4 = KeyboardButton(text='‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤')
b5 = KeyboardButton(text='üõí –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑')
b6 = KeyboardButton(text='‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è')
kb_client = ReplyKeyboardMarkup(
    keyboard=[
        [b1, b2],
        [b3, b4],
        [b5, b6]
        ],
    resize_keyboard=True
)
"""–û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.

–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–Ω–∏–∑—É —á–∞—Ç–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —à–µ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞:
‚Äî —Å–ø—Ä–∞–≤–∫–∞ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö,
‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞,
‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ –º–∞–≥–∞–∑–∏–Ω—É –Ω–∞ Wildberries,
‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤,
‚Äî –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑,
‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
"""
kb_inline = InlineKeyboardMarkup(inline_keyboard=[
    [
        InlineKeyboardButton(text=' Wildberries', url=WB)
    ],
])
"""Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –º–∞–≥–∞–∑–∏–Ω.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ ¬´–°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–≥–∞–∑–∏–Ω¬ª.
–°–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É, –≤–µ–¥—É—â—É—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞–≥–∞–∑–∏–Ω–∞ Wildberries.
"""
reviews_choice_kb = InlineKeyboardMarkup(inline_keyboard=[
    [
        InlineKeyboardButton(
            text='‚úèÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤', callback_data='review:start'
        )
    ]
])
"""Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞.

–ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ ¬´‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤¬ª –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
–°–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ FSM-—Å—Ü–µ–Ω–∞—Ä–∏—è –æ—Ç–∑—ã–≤–∞.
"""
suggestions_choice_kb = InlineKeyboardMarkup(inline_keyboard=[
    [
        InlineKeyboardButton(
            text='‚úèÔ∏è –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', callback_data='suggestions:start'
        )
    ]
])
"""Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è.

–ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ ¬´‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è¬ª –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
–°–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ FSM-—Å—Ü–µ–Ω–∞—Ä–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
"""
skip_kb = InlineKeyboardMarkup(
    inline_keyboard=[[InlineKeyboardButton(
        text="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="skip_photo"
        )]]
)
"""Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ."""


def get_review_product_selection_kb(products: list[dict]):
    """–°–æ–∑–¥–∞—ë—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ."""
    buttons = [
        [InlineKeyboardButton(
            text=prod['name'],
            callback_data=f"review_product_{prod['id']}"
        )]
        for prod in products
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_product_review_button(product_id: int):
    """–°–æ–∑–¥–∞—ë—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π ¬´–û—Ç–∑—ã–≤—ã¬ª –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.

    Args:
        product_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞.

    Returns:
        InlineKeyboardMarkup: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π,
                              callback_data: 'show_reviews_{product_id}'.
    """
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(
                text='‚≠ê –û—Ç–∑—ã–≤—ã',
                callback_data=f'show_reviews_{product_id}'
            )
        ]
    ])


def get_reviews_pagination_kb(
        product_id: int, page: int, total_reviews: int, per_page: int = 3
):
    """–°–æ–∑–¥–∞—ë—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤ –æ —Ç–æ–≤–∞—Ä–µ.

    Args:
        product_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞.
        page: –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1).
        total_reviews: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤.
        per_page: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3).

    Returns:
        InlineKeyboardMarkup: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:
                              - "‚Üê –ù–∞–∑–∞–¥" (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞),
                              - –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã / –æ–±—â–µ–µ —á–∏—Å–ª–æ —Å—Ç—Ä–∞–Ω–∏—Ü,
                              - "–í–ø–µ—Ä—ë–¥ ‚Üí" (–µ—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞).
                              –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–º–µ–Ω—è—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏.
    """
    total_pages = (total_reviews + per_page - 1) // per_page or 1
    page = max(1, min(page, total_pages))

    buttons = []
    nav_buttons = []
    if page > 1:
        nav_buttons.append(InlineKeyboardButton(
            text='‚Üê –ù–∞–∑–∞–¥', callback_data=f'reviews_page_{product_id}_{page-1}'
        ))
    else:
        nav_buttons.append(InlineKeyboardButton(
            text=' ', callback_data='noop'))

    nav_buttons.append(InlineKeyboardButton(
        text=f'{page} / {total_pages}', callback_data='noop'))

    if page < total_pages:
        nav_buttons.append(InlineKeyboardButton(
            text='–í–ø–µ—Ä—ë–¥ ‚Üí',
            callback_data=f'reviews_page_{product_id}_{page+1}'
        )
        )
    else:
        nav_buttons.append(InlineKeyboardButton(
            text=' ', callback_data='noop'))

    buttons.append(nav_buttons)
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_product_selection_kb(products):
    """–°–æ–∑–¥–∞—ë—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.

    Args:
        products: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ 'id' –∏ 'name'.

    Returns:
        InlineKeyboardMarkup: –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫,
                              –∫–∞–∂–¥–∞—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É.
                              Callback_data: 'order_prod_{id}'.
    """
    kb = []
    for p in products:
        kb.append(
            [InlineKeyboardButton(
                text=p['name'], callback_data=f'order_prod_{p['id']}'
                )]
        )
    return InlineKeyboardMarkup(inline_keyboard=kb)


def get_pvz_inline_kb(pvz_list: list[dict]):
    """–°–æ–∑–¥–∞—ë—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö –ü–í–ó (–ø—É–Ω–∫—Ç–æ–≤ –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–æ–≤).

    Args:
        pvz_list: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∫–ª—é—á–∞–º–∏ 'name', 'address', 'code'.

    Returns:
        –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Å–µ—á—ë–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å –ü–í–ó
            (–º–∞–∫—Å. 40 —Å–∏–º–≤–æ–ª–æ–≤ + "...").
            –ü–æ—Å–ª–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞ ‚Äî ¬´‚ùå –û—Ç–º–µ–Ω–∏—Ç—å¬ª —Å callback_data 'order_cancel'.
    """
    kb = []
    for pvz in pvz_list:
        text = f"{pvz['name']} ‚Äî {pvz['address']}"
        kb.append(
            [InlineKeyboardButton(
                text=text[:40] + '...', callback_data=f"pvz_{pvz['code']}"
                )]
        )
    kb.append(
        [InlineKeyboardButton(
            text='‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', callback_data='order_cancel')]
    )
    return InlineKeyboardMarkup(inline_keyboard=kb)


def get_order_confirmation_kb():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞.

    Returns:
        –î–≤–µ –∫–Ω–æ–ø–∫–∏:
            - ¬´‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª ‚Üí callback_data 'order_confirm',
            - ¬´‚ùå –û—Ç–º–µ–Ω–∏—Ç—å¬ª ‚Üí callback_data 'order_cancel'.
    """
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text='‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', callback_data='order_confirm'
                )
            ],
            [
                InlineKeyboardButton(
                    text='‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', callback_data='order_cancel'
                )
            ]
        ]
    )


def clean_address_label(text: str):
    """–£–±–∏—Ä–∞–µ—Ç '–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è:', '–ê–¥—Ä–µ—Å:' –∏ –ø–æ–¥–æ–±–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã."""
    if not text:
        return ""
    patterns = [
        r"–∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è\s*[:\-]?\s*",
        r"–ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏\s*[:\-]?\s*",
        r"–ø–≤–∑\s*[:\-]?\s*",
    ]
    cleaned = text.strip()
    for p in patterns:
        cleaned = re.sub(p, '', cleaned, flags=re.IGNORECASE)
    return cleaned.strip()


def extract_street_address(full_address: str, city_name: str):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —É–ª–∏—Ü—É –∏ –¥–æ–º –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞, —É–¥–∞–ª—è—è –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.

    Args:
        full_address: –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å, –≤–æ–∑–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—é—â–∏–π –≥–æ—Ä–æ–¥.
        city_name: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ –∞–¥—Ä–µ—Å–∞.

    Returns:
        str: –ê–¥—Ä–µ—Å –±–µ–∑ –≥–æ—Ä–æ–¥–∞. –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π.
    """
    if not full_address or not city_name:
        return full_address
    patterns = [
        rf'–≥\.?\s*{re.escape(city_name)}',
        rf'–≥–æ—Ä–æ–¥\s+{re.escape(city_name)}',
        rf'{re.escape(city_name)}',
        rf'{re.escape(city_name)},?\s*',
    ]
    cleaned = full_address
    for p in patterns:
        cleaned = re.sub(p, '', cleaned, flags=re.IGNORECASE)
    cleaned = re.sub(r'^[,\s\.]+', '', cleaned)
    cleaned = re.sub(r'[,\s\.]+$', '', cleaned)
    cleaned = re.sub(r'[,\s]{2,}', ', ', cleaned)
    return cleaned.strip() or full_address


def get_pvz_pagination_kb(
        pvz_list: list[dict],
        city_name: str,
        page: int = 0,
        items_per_page: int = 5):
    """–°–æ–∑–¥–∞—ë—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –ü–í–ó –≤ –≥–æ—Ä–æ–¥–µ.

    Args:
        pvz_list: –°–ø–∏—Å–æ–∫ –ü–í–ó (—Å–ª–æ–≤–∞—Ä–∏ —Å –∫–ª—é—á–∞–º–∏ 'code', 'address', 'name').
        city_name: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –∞–¥—Ä–µ—Å–∞).
        page: –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0).
        items_per_page: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ü–í–ó –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5).

    Returns:
        –ö–Ω–æ–ø–∫–∏ —Å —É–ª–∏—Ü–∞–º–∏ –ü–í–ó (–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞, –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤).
        –í–Ω–∏–∑—É ‚Äî –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ¬´‚¨ÖÔ∏è –ù–∞–∑–∞–¥¬ª / ¬´‚û°Ô∏è –í–ø–µ—Ä—ë–¥¬ª,
        –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.
        Callback_data –¥–ª—è –ü–í–ó: 'pvz_{code}',
        –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: 'pvz_page_{page_number}'.
    """
    start = page * items_per_page
    end = start + items_per_page
    current_page = pvz_list[start:end]
    buttons = []
    for i, pvz in enumerate(current_page):
        address = (pvz.get('address') or '').strip()
        if address:
            street = extract_street_address(address, city_name or "")
        else:
            name = (pvz.get('name') or '').strip()
            if name:
                name_clean = re.sub(r'^[A-Z0-9]+,\s*', '', name)
                street = extract_street_address(name_clean, city_name or "")
            else:
                street = f"–ü–í–ó {pvz['code']}"
        street = street.strip()
        if not street:
            street = f"–ü–í–ó {pvz['code']}"
        if len(street) > 60:
            street = street[:57] + '...'
        buttons.append([
            InlineKeyboardButton(
                text=street,
                callback_data=f"pvz_{pvz['code']}"
            )
        ])
    nav = []
    if page > 0:
        nav.append(InlineKeyboardButton(
            text='‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data=f'pvz_page_{page-1}')
        )
    if end < len(pvz_list):
        nav.append(InlineKeyboardButton(
            text='‚û°Ô∏è –í–ø–µ—Ä—ë–¥', callback_data=f'pvz_page_{page+1}')
        )
    if nav:
        buttons.append(nav)
    return InlineKeyboardMarkup(inline_keyboard=buttons)
